const basicAuth = require('basic-auth')

module.exports = (options, cb) => {
	return (req, res, body) => {
		const credentials = basicAuth(req)
		if (!credentials || !credentials.name || !credentials.pass) {
			unauthenticated(res)
		} else {
			options.database.authentication.load({
				username: credentials.name,
				password: credentials.pass
			}, (err) => {
				if (err) {
					console.log(`user is unauthenticated [${credentials.name}]`)
					unauthenticated(res)
				} else {
					cb(req, res, body)
				}
			})
		}
	}	
}

function unauthenticated(res) {
	res.statusCode = 401
	res.setHeader('WWW-Authenticate', 'Basic realm="example"')
	res.end('Access denied')
}
